name: Create Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string
      release_name:
        description: 'Release name (optional, defaults to tag)'
        required: false
        type: string
      pre_release:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  actions: read

jobs:
  create-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.create_tag.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create and push tag
        id: create_tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ inputs.tag }}" -m "Release ${{ inputs.tag }}"
          git push origin "${{ inputs.tag }}"
          echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT

  build-windows:
    needs: create-tag
    uses: ./.github/workflows/build_windows.yml
    with:
      tag: ${{ needs.create-tag.outputs.tag }}

  build-macos:
    needs: create-tag
    uses: ./.github/workflows/build_macos.yml
    with:
      tag: ${{ needs.create-tag.outputs.tag }}

  create-release:
    runs-on: ubuntu-latest
    needs: [create-tag, build-windows, build-macos]
    steps:
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: NextUI-Setup-Wizard-Windows-${{ needs.create-tag.outputs.tag }}
          path: ./artifacts

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: NextUI-Setup-Wizard-macOS-${{ needs.create-tag.outputs.tag }}
          path: ./artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.create-tag.outputs.tag }}
          name: ${{ inputs.release_name || needs.create-tag.outputs.tag }}
          prerelease: ${{ inputs.pre_release }}
          body: |
            ### For Windows users:

            **Requirements:**

            - Windows 10/11, x64



            **Instructions:**

            - Extract the **NextUI-Setup-Wizard-Windows-${{ needs.create-tag.outputs.tag }}.zip** and then open the `Launch NextUI Setup Wizard.bat` file to run the wizard.



            ---



            ### For Mac users:

            **Requirements:**

            - macOS 15.0+, arm64



            **Instructions:**

            - Extract the **NextUI-Setup-Wizard-macOS-${{ needs.create-tag.outputs.tag }}.zip** and then open the `NextUI Setup Wizard-1.0.pkg`.

            - You will receive a popup that says the app cannot be opened. Follow the instructions here to proceed https://support.apple.com/en-us/102445#openanyway:

              1. Open System Settings.

              2. Click Privacy & Security, scroll down, and click the Open Anyway button to confirm your intent to open or install the app.

              3. The warning prompt reappears and, if you're absolutely sure that you want to open the app anyway, you can click Open.

              4. The app is now saved as an exception to your security settings, and you can open it in the future by double-clicking it, just as you can any authorized app.
          files: |
            ./artifacts/NextUI-Setup-Wizard-Windows-${{ needs.create-tag.outputs.tag }}.zip
            ./artifacts/NextUI-Setup-Wizard-macOS-${{ needs.create-tag.outputs.tag }}.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}